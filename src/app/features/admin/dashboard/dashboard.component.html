<div class="container-fluid py-5 min-vh-100">

  <div *ngIf="loading" class="text-center py-5">
    <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;"></div>
    <p class="mt-3 text-secondary fw-bold">Procesando datos...</p>
  </div>

  <div *ngIf="error" class="alert alert-danger border-0 shadow-sm d-flex align-items-center rounded-3">
    <i class="bi bi-exclamation-octagon-fill me-3 fs-3"></i>
    <div>{{ error }}</div>
  </div>

  <div *ngIf="!loading && !error" class="fade-in">
    
    <div class="row g-4 mb-5">
      
      <div class="col-12 col-md-6 col-xl-3">
        <div class="card h-100 kpi-card kpi-primary">
          <div class="card-body">
            <div class="d-flex justify-content-between align-items-start mb-3">
              <div>
                <h6 class="text-muted text-uppercase small fw-bold mb-1">Ventas Totales</h6>
                <h2 class="mb-0 fw-bolder display-6 text-dark">{{ ventasMes }}</h2>
              </div>
              <div class="icon-box shadow-sm">
                <i class="bi bi-bag-check-fill"></i>
              </div>
            </div>
            <div class="d-flex align-items-center">
              <span class="badge rounded-pill bg-primary bg-opacity-10 text-primary px-3 py-2">
                <i class="bi bi-graph-up"></i> Mes Actual
              </span>
            </div>
          </div>
        </div>
      </div>

      <div class="col-12 col-md-6 col-xl-3">
        <div class="card h-100 kpi-card kpi-success">
          <div class="card-body">
            <div class="d-flex justify-content-between align-items-start mb-3">
              <div>
                <h6 class="text-muted text-uppercase small fw-bold mb-1">Ganancias</h6>
                <h2 class="mb-0 fw-bolder display-6 text-dark">S/ {{ gananciasMes | number:'1.2-2' }}</h2>
              </div>
              <div class="icon-box shadow-sm">
                <i class="bi bi-cash-coin"></i>
              </div>
            </div>
            <div class="d-flex align-items-center">
              <span class="badge rounded-pill bg-success bg-opacity-10 text-success px-3 py-2">
                <i class="bi bi-wallet2"></i> Neto
              </span>
            </div>
          </div>
        </div>
      </div>

      <div class="col-12 col-md-6 col-xl-3">
        <div class="card h-100 kpi-card kpi-info">
          <div class="card-body">
            <div class="d-flex justify-content-between align-items-start mb-3">
              <div>
                <h6 class="text-muted text-uppercase small fw-bold mb-1">Ticket Promedio</h6>
                <h2 class="mb-0 fw-bolder display-6 text-dark">S/ {{ ticketPromedio | number:'1.2-2' }}</h2>
              </div>
              <div class="icon-box shadow-sm">
                <i class="bi bi-receipt-cutoff"></i>
              </div>
            </div>
            <div class="d-flex align-items-center">
              <span class="text-muted small">Promedio por transacción</span>
            </div>
          </div>
        </div>
      </div>

      <div class="col-12 col-md-6 col-xl-3">
        <div class="card h-100 kpi-card" [ngClass]="productosBajoStock.length > 0 ? 'kpi-danger' : 'kpi-success'">
          <div class="card-body">
            <div class="d-flex justify-content-between align-items-start mb-3">
              <div>
                <h6 class="text-muted text-uppercase small fw-bold mb-1">Stock Crítico</h6>
                <h2 class="mb-0 fw-bolder display-6 text-dark">{{ productosBajoStock.length }}</h2>
              </div>
              <div class="icon-box shadow-sm">
                <i class="bi" [ngClass]="productosBajoStock.length > 0 ? 'bi-exclamation-diamond-fill' : 'bi-check-circle-fill'"></i>
              </div>
            </div>
            <div class="d-flex align-items-center">
              <span class="fw-bold small" [ngClass]="productosBajoStock.length > 0 ? 'text-danger' : 'text-success'">
                {{ productosBajoStock.length > 0 ? 'Reponer inventario urgente' : 'Todo bajo control' }}
              </span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="row g-4 mb-5">
      <div class="col-lg-8">
        <div class="card h-100">
          <div class="card-header d-flex justify-content-between align-items-center">
            <h5 class="m-0 fw-bold text-secondary">Tendencia de Ingresos</h5>
            <button class="btn btn-sm btn-light rounded-circle"><i class="bi bi-three-dots-vertical"></i></button>
          </div>
          <div class="card-body">
            <div style="position: relative; height: 320px; width: 100%;">
              <canvas #lineCanvas></canvas>
            </div>
          </div>
        </div>
      </div>

      <div class="col-lg-4">
        <div class="card h-100">
          <div class="card-header d-flex justify-content-between align-items-center">
            <h5 class="m-0 fw-bold text-secondary">Por Categoría</h5>
            <small class="text-muted">Top Ventas</small>
          </div>
          <div class="card-body d-flex flex-column align-items-center justify-content-center">
            <div style="position: relative; height: 260px; width: 100%;">
              <canvas #pieCanvas></canvas>
            </div>
            <div class="mt-4 text-center text-muted small">
              <i class="bi bi-hand-index-thumb-fill text-primary me-1"></i> Haz clic en un color para ver detalles
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="row g-4">
      
      <div class="col-lg-4">
        <div class="card h-100">
          <div class="card-header">
            <h6 class="m-0 fw-bold text-primary"><i class="bi bi-star-fill me-2"></i>Productos Estrella</h6>
          </div>
          <div class="table-responsive">
            <table class="table mb-0">
              <thead>
                <tr>
                  <th>Producto</th>
                  <th class="text-end">Vol.</th>
                  <th class="text-end">Total</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let p of topProductos">
                  <td>
                    <div class="fw-bold text-truncate" style="max-width: 160px;" title="{{p.nombre}}">{{ p.nombre }}</div>
                  </td>
                  <td class="text-end">
                    <span class="custom-badge badge-soft-primary">{{ p.cantidadVendida }}</span>
                  </td>
                  <td class="text-end text-secondary fw-bold small">S/{{ p.totalVenta | number:'1.0-0' }}</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <div class="col-lg-4">
        <div class="card h-100">
          <div class="card-header">
            <h6 class="m-0 fw-bold text-danger"><i class="bi bi-battery-half me-2"></i>Stock Crítico</h6>
          </div>
          <div class="table-responsive">
            <table class="table mb-0">
              <thead>
                <tr>
                  <th>Producto</th>
                  <th class="text-end">Quedan</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let p of productosBajoStock">
                  <td>
                    <div class="text-truncate" style="max-width: 190px;" title="{{p.nombre}}">{{ p.nombre }}</div>
                  </td>
                  <td class="text-end">
                    <span class="fw-bold text-danger">{{ p.stock }} un.</span>
                  </td>
                </tr>
                <tr *ngIf="productosBajoStock.length === 0">
                  <td colspan="2" class="text-center py-5 text-muted">
                    <i class="bi bi-shield-check fs-1 d-block mb-2 text-success opacity-50"></i>
                    Inventario Saludable
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <div class="col-lg-4">
        <div class="card h-100">
          <div class="card-header">
            <h6 class="m-0 fw-bold text-secondary"><i class="bi bi-archive me-2"></i>Sin Movimiento</h6>
          </div>
          <div class="table-responsive">
            <table class="table mb-0">
              <thead>
                <tr>
                  <th>Producto</th>
                  <th class="text-end">Stock</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let p of productosZombies">
                  <td class="text-muted">
                    <div class="text-truncate" style="max-width: 190px;" title="{{p.nombre}}">{{ p.nombre }}</div>
                  </td>
                  <td class="text-end text-muted">{{ p.stock }}</td>
                </tr>
                <tr *ngIf="productosZombies.length === 0">
                  <td colspan="2" class="text-center py-5 text-muted">
                    Todo se vende.
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>

    </div>
  </div>
</div>