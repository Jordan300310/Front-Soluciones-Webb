<div class="container my-4">
  <h2 class="mb-3">Mi perfil</h2>

  <p class="text-muted">
    Sesión iniciada como <strong>{{ username }}</strong>
  </p>

  <!-- Tabs -->
  <ul class="nav nav-tabs">
    <li class="nav-item">
      <button
        class="nav-link"
        [class.active]="activeTab === 'datos'"
        type="button"
        (click)="cambiarTab('datos')"
      >
        Datos personales
      </button>
    </li>
    <li class="nav-item">
      <button
        class="nav-link"
        [class.active]="activeTab === 'password'"
        type="button"
        (click)="cambiarTab('password')"
      >
        Cambiar contraseña
      </button>
    </li>
    <li class="nav-item">
      <button
        class="nav-link"
        [class.active]="activeTab === 'pedidos'"
        type="button"
        (click)="cambiarTab('pedidos')"
      >
        Mis pedidos
      </button>
    </li>
  </ul>

  <div class="tab-content mt-3">
    <!-- DATOS PERSONALES (SOLO LECTURA + BOTÓN ACTUALIZAR) -->
    <div [hidden]="activeTab !== 'datos'">
      <div *ngIf="mensajePerfil" class="alert alert-success">
        {{ mensajePerfil }}
      </div>

      <div *ngIf="errorPerfil" class="alert alert-danger">
        {{ errorPerfil }}
      </div>

      <div class="row g-3">
        <div class="col-md-4">
          <label class="form-label">Nombres</label>
          <p class="form-control-plaintext">
            {{ perfil?.nombres || '-' }}
          </p>
        </div>

        <div class="col-md-4">
          <label class="form-label">Apellido paterno</label>
          <p class="form-control-plaintext">
            {{ perfil?.apellidoPaterno || '-' }}
          </p>
        </div>

        <div class="col-md-4">
          <label class="form-label">Apellido materno</label>
          <p class="form-control-plaintext">
            {{ perfil?.apellidoMaterno || '-' }}
          </p>
        </div>

        <div class="col-md-4">
          <label class="form-label">DNI</label>
          <p class="form-control-plaintext">
            {{ perfil?.dni || '-' }}
          </p>
        </div>

        <div class="col-md-4">
          <label class="form-label">Celular</label>
          <p class="form-control-plaintext">
            {{ perfil?.celular || '-' }}
          </p>
        </div>

        <div class="col-md-4">
          <label class="form-label">Email</label>
          <p class="form-control-plaintext">
            {{ perfil?.email || '-' }}
          </p>
        </div>

        <div class="col-md-4">
          <label class="form-label">Fecha de nacimiento</label>
          <p class="form-control-plaintext">
            {{ perfil?.fechaNacimiento || '-' }}
          </p>
        </div>
      </div>

      <div class="mt-3">
        <button class="btn btn-outline-primary" type="button" (click)="abrirModalDatos()">
          Actualizar datos
        </button>
      </div>
    </div>

    <!-- CAMBIAR CONTRASEÑA -->
    <div [hidden]="activeTab !== 'password'">
      <div *ngIf="mensajePassword" class="alert alert-success">
        {{ mensajePassword }}
      </div>

      <div *ngIf="errorPassword" class="alert alert-danger">
        {{ errorPassword }}
      </div>

      <form [formGroup]="passwordForm" (ngSubmit)="onSubmitPassword()">
        <div class="row g-3">
          <div class="col-md-4">
            <label class="form-label">Contraseña actual</label>
            <input
              type="password"
              class="form-control"
              formControlName="currentPassword"
            />
          </div>

          <div class="col-md-4">
            <label class="form-label">Nueva contraseña</label>
            <input type="password" class="form-control" formControlName="newPassword" />
          </div>

          <div class="col-md-4">
            <label class="form-label">Confirmar nueva contraseña</label>
            <input
              type="password"
              class="form-control"
              formControlName="confirmPassword"
            />
          </div>
        </div>

        <div class="mt-3">
          <button
            class="btn btn-primary"
            type="submit"
            [disabled]="passwordForm.invalid"
          >
            Cambiar contraseña
          </button>
        </div>
      </form>
    </div>

    <!-- MIS PEDIDOS -->
    <div [hidden]="activeTab !== 'pedidos'">
      <div *ngIf="errorPedidos" class="alert alert-danger">
        {{ errorPedidos }}
      </div>

      <div *ngIf="!errorPedidos && pedidos.length === 0">
        <p class="text-muted">No tienes pedidos registrados.</p>
      </div>

      <div *ngIf="pedidos.length > 0" class="row g-3">
        <div class="col-md-6" *ngFor="let pedido of pedidos">
          <div class="card h-100">
            <div class="card-body">
              <h6 class="card-title mb-2">
                Pedido #{{ pedido.idVenta }}
                <span *ngIf="pedido.numeroComprobante">
                  - {{ pedido.numeroComprobante }}
                </span>
              </h6>

              <p class="mb-1">
                <strong>Fecha:</strong>
                {{ pedido.fechaVenta | date: 'short' }}
              </p>

              <p class="mb-1">
                <strong>Entrega:</strong>
                {{ pedido.direccion }},
                {{ pedido.ciudad }},
                {{ pedido.pais }}
              </p>

              <p class="mb-2" *ngIf="pedido.total != null">
                <strong>Total del pedido:</strong>
                S/ {{ pedido.total | number: '1.2-2' }}
              </p>

              <hr class="my-2" />

              <!-- Productos -->
              <div *ngFor="let prod of pedido.productos" class="d-flex mb-2">
                <div class="me-2" style="width: 80px;">
                  <img
                    [src]="prod.imagenUrl || 'assets/no-image.png'"
                    class="img-fluid rounded"
                    alt="{{ prod.nombreProducto }}"
                  />
                </div>
                <div class="flex-grow-1">
                  <div class="fw-semibold">
                    {{ prod.nombreProducto }}
                  </div>
                  <div class="small">
                    Cantidad: {{ prod.cantidad }} |
                    P. unitario: S/
                    {{ prod.precioUnitario | number: '1.2-2' }} |
                    Subtotal: S/
                    {{ prod.subtotal | number: '1.2-2' }}
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- MODAL PARA EDITAR DATOS PERSONALES -->
  <div
    class="modal fade show d-block"
    tabindex="-1"
    role="dialog"
    *ngIf="showEditModal"
    style="background: rgba(0,0,0,0.5);"
  >
    <div class="modal-dialog modal-lg" role="document">
      <div class="modal-content">
        <form [formGroup]="personalForm" (ngSubmit)="onSubmitDatos()">
          <div class="modal-header">
            <h5 class="modal-title">Actualizar datos personales</h5>
            <button
              type="button"
              class="btn-close"
              aria-label="Close"
              (click)="cerrarModalDatos()"
            ></button>
          </div>

          <div class="modal-body">
            <div class="row g-3">
              <div class="col-md-4">
                <label class="form-label">Nombres</label>
                <input type="text" class="form-control" formControlName="nombres" />
              </div>

              <div class="col-md-4">
                <label class="form-label">Apellido paterno</label>
                <input
                  type="text"
                  class="form-control"
                  formControlName="apellidoPaterno"
                />
              </div>

              <div class="col-md-4">
                <label class="form-label">Apellido materno</label>
                <input
                  type="text"
                  class="form-control"
                  formControlName="apellidoMaterno"
                />
              </div>

              <div class="col-md-4">
                <label class="form-label">DNI</label>
                <input
                  type="text"
                  class="form-control bg-light"
                  formControlName="dni"
                  readonly
                />
              </div>

              <div class="col-md-4">
                <label class="form-label">Celular</label>
                <input type="text" class="form-control" formControlName="celular" />
              </div>

              <div class="col-md-4">
                <label class="form-label">Email</label>
                <input type="email" class="form-control" formControlName="email" />
                <div
                  class="text-danger small"
                  *ngIf="
                    personalForm.get('email')?.invalid &&
                    personalForm.get('email')?.touched
                  "
                >
                  Email inválido.
                </div>
              </div>

              <div class="col-md-4">
                <label class="form-label">Fecha de nacimiento</label>
                <input
                  type="date"
                  class="form-control bg-light"
                  formControlName="fechaNacimiento"
                  readonly
                />
              </div>
            </div>
          </div>

          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              (click)="cerrarModalDatos()"
            >
              Cancelar
            </button>
            <button
              class="btn btn-primary"
              type="submit"
              [disabled]="personalForm.invalid"
            >
              Guardar cambios
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>
